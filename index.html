<html>

<head>
</head>


<body>


<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 20px;"> 

	<div style="display: flex; flex-direction: row;"> 
	
		
	</div>


	<div style="display: flex; flex-direction: row; width: 800px; margin: 10px 0px 0px 0px; border:1px solid #333333;"> 
		<div style="display: flex; flex-direction: column;"> 
			<label style="font-size: 80%;"><b>MODEL FOLDER</b></label>
			<select id="selModel" style="width: 300px;"></select>
		</div>

		<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 10px;"> 
			<label style="font-size: 80%;"><b>SPEAKER</b></label>
			<select id="selSpeaker" style="width: 200px;" size="1"></select>
		</div>		
		<div style="display: flex; flex-direction: column; margin: 0px 0px 5px 0px;"> 
			<label style="font-size: 80%;"><b>単語で絞込</b></label>
			<input type="text" id="selSpeakerSerch" style="width: 150px; height: 20px;" value="" data-targetid="selSpeaker">
		</div>
		

		
	</div>
	
	<!-- Generate -->
	<div style="display: flex; flex-direction: row; margin: 20px 0px 0px 0px;">

		<div style="display: flex; flex-direction: column;">

			<div style="display: flex; flex-direction: row;">
				<div style="display: flex; flex-direction: column;">
				
					<label style="font-size: 80%;"><b>変換タイプ選択</b></label>
					<select id="selConvertType" style="width: 300px;"></select>
					
				</div>
				
				<label id="info" style="font-size: 70%; width: 300px; height: 40px; border:1px solid #333333; margin: 0px 0px 5px 50px;">Log</label>
			</div>
<!--
			<label style="font-size: 80%;" data-uitype="TTS"><b>テキストから生成</b></label>
			<label style="font-size: 80%;" data-uitype="VTS"><b>音声ファイルから生成</b></label>
			<label style="font-size: 80%;" data-uitype="HuBERT"><b>音声ファイルから生成( HuBERT-VITS )</b></label>
			<label style="font-size: 80%;" data-uitype="W2V2"><b>テキストと感情指定から生成</b></label>
-->
			<div style="display: flex; flex-direction: row; border:1px solid #333333;"> 
			
				<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 10px;" data-uitype="TTS W2V2">
					<div style="flex-direction: row;">

						<label style="font-size: 80%;"><b>CLENER</b></label>

						<input id="chkAutoJA" type="checkbox"  style="margin: 0px 0px 0px 20px;" checked>
						<label style="font-size: 60%; margin: 0px 0px 10px 0px;"><b>[JA]自動処理</b></label>

						<input id="chkRunMarine" type="checkbox"  style="margin: 0px 0px 0px 20px;" checked>
						<label style="font-size: 60%; margin: 0px 0px 10px 0px;"><b>marine を使う</b></label>
						
					</div>
					<select id="selClener" style="width: 350px;">
						<option value="">--- モデルに設定されてるデフォルト ---</option>
						<option value="japanese_cleaners">japanese_cleaners</option>
						<option value="japanese_cleaners2">japanese_cleaners2</option>
						<option value="zh_ja_mixture_cleaners">zh_ja_mixture_cleaners</option>
						<option value="cjks_cleaners">cjks_cleaners</option>
						<option value="cjke_cleaners">cjke_cleaners</option>
						<option value="cjke_cleaners2">cjke_cleaners2</option>
			<!--
						<option value="chinese_dialect_cleaners">chinese_dialect_cleaners</option>
						<option value="chinese_cleaners">chinese_cleaners</option>
						<option value="korean_cleaners">korean_cleaners</option>
						<option value="sanskrit_cleaners">sanskrit_cleaners</option>
						<option value="thai_cleaners">thai_cleaners</option>
						<option value="shanghainese_cleaners">shanghainese_cleaners</option>
			-->			
					</select>
				</div>
				
				<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 20px;" data-uitype="TTS HuBERT W2V2">
					<div style="display: flex; flex-direction: row; margin: 5px 0px 0px 0px;">
						<label style="font-size: 80%;">速度 : </label>
						<b><label id="speedLabel" style="font-size: 90%;">1.0</label></b>
					</div>
					<input type="range" id="speedSlider" oninput="changeSlider" value="1.0" min="0.1" max="2" step="0.1" data-targetlabel="speedLabel">
				</div>

				<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 20px;" data-uitype="TTS HuBERT W2V2">
					<div style="display: flex; flex-direction: row; margin: 5px 0px 0px 0px;">
						<label style="font-size: 80%;">ノイズ : </label>
						<b><label id="noiseLabel" style="font-size: 90%;">0.67</label></b>
					</div>
					<input type="range" id="noiseSlider" oninput="changeSlider" value="0.67" min="0.1" max="2" step="0.01" data-targetlabel="noiseLabel">
				</div>
				
				<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 20px;" data-uitype="TTS HuBERT W2V2">
					<div style="display: flex; flex-direction: row; margin: 5px 0px 0px 0px;">
						<label style="font-size: 80%;">ノイズW : </label>
						<b><label id="noisewLabel" style="font-size: 90%;">0.8</label></b>
					</div>
					<input type="range" id="noisewSlider" oninput="changeSlider" value="0.8" min="0.1" max="2" step="0.01" data-targetlabel="noisewLabel">
				</div>
				
			</div>

			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="VTS">
				<div style="display: flex; flex-direction: column; margin: 0px 0px 5px 10px;"> 
					<label id="selTargetSpeakerLabel" style="font-size: 80%;"><b>TARGET SPEAKER</b></label>
					<select id="selTargetSpeaker" style="width: 200px;" size="1"></select>
				</div>
				<div style="display: flex; flex-direction: column; margin: 0px 0px 5px 0px;"> 
					<label id="selTargetSpeakerSerchLabel" style="font-size: 80%;"><b>単語で絞込</b></label>
					<input type="text" id="selTargetSpeakerSerch" style="width: 150px; height: 20px;" value="" data-targetid="selTargetSpeaker">
				</div>
			</div>
<!--
			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="TTS W2V2">
				<div style="display: flex; flex-direction: column; margin: 0px 0px 5px 10px;"> 
					<div style="display: flex; flex-direction: row; margin: 5px 0px 0px 0px;"> 
						<label id="dummyTextLabel" style="font-size: 80%;"><b>テスト用ランダムテキスト</b></label>
						<label style="font-size: 80%; margin: 0px 0px 0px 30px;"><b>辞書</b></label>
						<select id="selDummyTextDict" style="width: 200px; margin: 0px 0px 3px 3px;">
							<option value="">--- なし ---</option>
						</select>
					</div>
					<div style="display: flex; flex-direction: row;"> 
						<button id="buttonDummyTextGenerate" style="width: 60px; height: 30px;">生成</button>
						<select id="selDummyText" style="width: 800px; height: 30px;">
							<option value="">--- なし ---</option>
						</select>
					</div>
				</div>
			</div>
-->
			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="W2V2">
				<div style="display: flex; flex-direction: column; margin: 0px 0px 5px 10px;"> 
					<label id="dummyTextLabel" style="font-size: 80%;"><b>感情設定</b></label>
					<select id="selEmoteFile" style="width: 200px; height: 30px;"></select>
				</div>
				<div style="display: flex; flex-direction: column; margin: 0px 0px 0px 20px;" data-uitype="TTS HuBERT W2V2">
					<div style="display: flex; flex-direction: row; margin: 5px 0px 0px 0px;">
						<label style="font-size: 80%;">感情付け重み : </label>
						<b><label id="emoteWeightLabel" style="font-size: 90%;">1.0</label></b>
					</div>
					<input type="range" id="emoteWeightSlider" oninput="changeSlider" value="1.0" min="0.1" max="2" step="0.01" data-targetlabel="emoteWeightLabel">
				</div>

			</div>

			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="TTS W2V2">
				<label style="font-size: 80%; width: 60px; height: 30px; margin: 10px 0px 0px 10px;"><b>テキスト</b></label>
				<input id="srcRawText" type="text" style="width: 800px; height: 30px; border:2px solid #333333; margin: 5px 0px 0px 0px;"></input>
				<button id="buttonGenerateText" style="width: 60px; height: 30px; margin: 5px 0px 0px 0px;" data-srcid="srcRawText" data-iscleaned="false">生成</button>
			</div>
			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="TTS W2V2">
				<label style="font-size: 80%; width: 60px; height: 30px; margin: 10px 0px 0px 10px;"><b>音素</b></label>
				<input id="srcCleanText" type="text" style="width: 800px; height: 30px; border:2px solid #333333; margin: 5px 0px 0px 0px;"></input>
				<button id="buttonSymbolText" style="width: 60px; height: 30px; margin: 5px 0px 0px 0px;" data-srcid="srcCleanText" data-iscleaned="true">生成</button>
			</div>
			<div style="display: flex; flex-direction: row; border:1px solid #333333;" data-uitype="VTS HuBERT">
				<label style="font-size: 80%; width: 60px; height: 30px; margin: 20px 0px 0px 10px;"><b>ファイル</b></label>
				<div style="display: flex; flex-direction: column; margin: 2px 0px 2px 0px;">
					<label id="audioSrcLabel" style="font-size: 80%; width: 800px; height: 25px; border:2px dashed; margin: 0px 0px 0px 0px;">
						　------------- ここに変換元 .wav ファイルをドロップ -----------------
					</label>
					<audio id="audioSrc" style="width: 800px; height: 25px; margin: 2px 0px 0px 0px;" controls></audio>
				</div>
				<button id="buttonGenerateAudio" style="width: 60px; height: 30px; margin: 15px 0px 0px 0px;" data-srcid="audioSrc">生成</button>
			</div>
<!--
			<div style="display: flex; flex-direction: row; border:1px solid #333333; margin: 20px 0px 0px 0px;">
				<label style="font-size: 80%; width: 60px; height: 30px; margin: 10px 0px 0px 10px;"><b>結果</b></label>
				<audio id="distAudio" style="width: 800px; height: 25px; margin: 7px 0px 0px 0px;filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);" controls loop></audio>
			</div>
-->
		</div>

	</div>	<!-- Generate -->


	<div style="display: flex; flex-direction: column; margin: 30px 0px 0px 0px;">
		<label style="font-size: 80%;"><b>生成リスト</b></label>
		<div id="containerHistory"></div>
	</div>

</div>



<br>
<div style="height: 1px; display: flex; flex-direction: column; border:1px solid #333333; margin: 5px 0px 0px 0px;"></div>
CREDIT
<div style="display: flex; flex-direction: column;"> 

	<div style="display: flex; flex-direction: row;"> 
		<label><b>MoeGoe</b>　</label>
		<a href="https://github.com/CjangCjengh/MoeGoe" target="_blank" rel="noopener noreferrer">https://github.com/CjangCjengh/MoeGoe</a>
		<label>　ベースのコード</label>
	</div>

	<div style="display: flex; flex-direction: row;"> 
		<label><b>pyopenjtalk</b>　</label>
		<a href="https://github.com/r9y9/pyopenjtalk" target="_blank" rel="noopener noreferrer">https://github.com/r9y9/pyopenjtalk</a>
		<label>　日本語テキストをアクセント付きの音素に分解してくれる</label>
	</div>

	<div style="display: flex; flex-direction: row;"> 
		<label><b>marine</b>　</label>
		<a href="https://github.com/6gsn/marine" target="_blank" rel="noopener noreferrer">https://github.com/6gsn/marine</a>
		<label>　マルチタスク学習ベースの日本語アクセント推定</label>
	</div>

	<div style="display: flex; flex-direction: row;"> 
		<label><b>Flask</b>　</label>
		<a href="https://palletsprojects.com/p/flask/" target="_blank" rel="noopener noreferrer">https://palletsprojects.com/p/flask/</a>
		<label>　Python でのシンプルな WEB アプリケーション構築フレームワーク</label>
	</div>

</div>


<!--
<button onclick="test();">
test
</button>
-->



<script>

//////////////////////////////////////////////////////////////////
function setSelect( targetId, val ){
	let target = document.querySelector( "#" + targetId );
	let options = target.options;
	let len = options.length;
	for( let i = 0; i < len; i++ ){
		if( options[ i ].value == val ){
			options[ i ].selected = true;
		}
	}
}

//////////////////////////////////////////////////////////////////

function removeAllChildNodes( parent ){
	while( parent.firstChild ){
		parent.removeChild( parent.firstChild );
	}
}

//////////////////////////////////////////////////////////////////
var modelDatas = [];
var modelDatas_isHubert = false;
var npyDatas = [];

function getAllDatas(){

	lockUI( true );
	
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function () {
		if( xhttp.readyState === XMLHttpRequest.DONE ){
		
			const status = xhttp.status;
			let res = JSON.parse( this.response );
			
			if( status === 0 || ( status >= 200 && status < 400 ) ){
console.log( res );

				modelDatas_isHubert = ( res.isHubert == "true" ) ? true : false;
				modelDatas = res.modelDatas;
				let len = modelDatas.length;
				for( let i = 0; i < len; i++ ){

					modelDatas[ i ].selModelText = 
						  modelDatas[ i ].modelDir
						+ " : " + modelDatas[ i ].model_type
						+ " : " + modelDatas[ i ].speakers.length
						+ " : " + modelDatas[ i ].text_cleaners
					;
					
				}
				
				updateSelectModel();
				changeModel();
				document.querySelector( "#selModel" ).addEventListener( "change", changeModel );

				npyDatas = res.npyDatas;
				setEmoteFile();

			} else {
				setInfo( "SERVER_ERROR : Status " + status );
			}
			
			lockUI( false );
		}
	};
	xhttp.open( "POST", "http://127.0.0.1:15000/getAllDatas", true );
	xhttp.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" );
	xhttp.send( "" );
}

function changeModel(){
	updateSelectSpeaker();
	updateConvertType();
}
///////////////////////////////////////////////////////////////
function getSelectModelData( modelDir ){
	let len = modelDatas.length;
	for( let i = 0; i < len; i++){
		if( modelDatas[ i ].modelDir == modelDir ){
			return modelDatas[ i ];
		}
	}
	return null;
}
///////////////////////////////////////////////////////////////
function setUIBaseDisplay(){
	const elments = document.querySelectorAll('[data-uitype]');
	for( let i = 0; i < elments.length; i++ ){
		elments[ i ].baseDisplay = elments[ i ].style.display;
	}
}

function changeUIType(){

	let type = document.querySelector( "#selConvertType" ).value;
	const elments = document.querySelectorAll('[data-uitype]');

	for( let i = 0; i < elments.length; i++ ){
		if( elments[ i ].dataset.uitype.match( type ) ){
			elments[ i ].style.display = elments[ i ].baseDisplay;
		} else {
			elments[ i ].style.display = "none";
		}
	}
	
	// TTS W2V2
	if( type == "TTS" ){
		setSlider( 1.0, 0.67, 0.8 );
	} else if( type == "VTS" ){
		setSlider( 1.0, 0.67, 0.8 );
	} else if( type == "HuBERT" ){
		setSlider( 1.0, 0.1, 0.1 );
	} else if( type == "W2V2" ){
		setSlider( 1.0, 0.67, 0.8 );
	} else { /* Unknown */
		setSlider( 1.0, 0.67, 0.8 );
	}
	
}

///////////////////////////////////////////////////////////////
document.querySelector( "#selConvertType" ).addEventListener( 'change', changeUIType );
function updateConvertType(){

	let modelData = getSelectModelData(	document.querySelector( "#selModel" ).value );
	let types = modelData.model_type;

	let selConvertType = document.querySelector( "#selConvertType" );
	removeAllChildNodes( selConvertType );
	
	if( types.includes( "TTS" ) ){
		let op = document.createElement( "option" );
		op.value = "TTS";
		op.text = "TTS : テキストから生成";
		selConvertType.appendChild( op );
	}
	if( types.includes( "VTS" ) ){
		let op = document.createElement( "option" );
		op.value = "VTS";
		op.text = "VTS : 音声ファイルから生成";
		selConvertType.appendChild( op );
	}
	if( types.includes( "HuBERT" ) ){
		let op = document.createElement( "option" );
		op.value = "HuBERT";
		op.text = "HuBERT : 音声ファイルから生成";
		selConvertType.appendChild( op );
	}
	if( types.includes( "W2V2" ) ){
		let op = document.createElement( "option" );
		op.value = "W2V2";
		op.text = "W2V2 : テキスト入力 + 感情指定から生成";
		selConvertType.appendChild( op );
	}


	changeUIType();
}


///////////////////////////////////////////////////////////////
function updateSelectModel(){

	let sel = document.querySelector( "#selModel" );
	removeAllChildNodes( sel );
	
	let len = modelDatas.length;
	let isSelected = false;
	for( let i = 0; i < len; i++ ){
		
		let option = document.createElement( "option" );
		option.value = modelDatas[ i ].modelDir;
		option.text = modelDatas[ i ].selModelText;
		if( modelDatas[ i ].model_type.includes( "HuBERT" ) && modelDatas_isHubert == false ){
			option.disabled = true;
		}

		if( modelDatas[ i ].model_type.length == 0 ){ /* Unknown */
			option.disabled = true;
		}
		if( isSelected == false &&  option.disabled == false ){
			option.selected = true;
			isSelected = true;
		}
		sel.appendChild( option );
	}
	
	if( modelDatas.length > 0 ){
		updateSelectSpeaker();
	}
	
}

///////////////////////////////////////////////////////////////
function updateSelectSpeaker(){

	let speakerSerch = document.querySelector( "#selSpeakerSerch" );
	speakerSerch.value = "";
	let sel = document.querySelector( "#selSpeaker" );
	sel.value = 0;
	removeAllChildNodes( sel );

	let selTargetSpeakerSerch = document.querySelector( "#selTargetSpeakerSerch" );
	selTargetSpeakerSerch.value = "";
	let selTarget = document.querySelector( "#selTargetSpeaker" );
	selTarget.value = 0;
	removeAllChildNodes( selTarget );

	let modelData = getSelectModelData(	document.querySelector( "#selModel" ).value );
	
	speakers = modelData.speakers;
	let len = speakers.length;
	for( let i = 0; i < len; i++ ){
		let option = document.createElement( "option" );
		option.value = i;
		option.text = speakers[ i ];
		sel.appendChild( option );
	}
	for( let i = 0; i < len; i++ ){
		let option = document.createElement( "option" );
		option.value = i;
		option.text = speakers[ i ];
		selTarget.appendChild( option );
	}
}


///////////////////////////////////////////////////////////////
document.querySelector( "#selSpeakerSerch" ).addEventListener( 'change', changeSpeakerSerch );
document.querySelector( "#selTargetSpeakerSerch" ).addEventListener( 'change', changeSpeakerSerch );

function changeSpeakerSerch( e ){
	
	let word = e.target.value;
	let targetid = e.target.dataset.targetid;
	let sel = document.querySelector( "#" + targetid );
	removeAllChildNodes( sel );
	sel.value = "";


	let modelData = getSelectModelData(	document.querySelector( "#selModel" ).value );
	speakers = modelData.speakers;
	let len = speakers.length;
	for( let i = 0; i < len; i++ ){
		if( speakers[ i ].indexOf( word ) != -1 ){
			let option = document.createElement( "option" );
			option.value = i;
			option.text = speakers[ i ];
			sel.appendChild( option );
		}
	}
	if( sel.childNodes.length != 0 ){
		sel.childNodes[ 0 ].selected  = true;
		sel.value = sel.childNodes[ 0 ].value;
	}
}

///////////////////////////////////////////////////////////////
function setEmoteFile(){
	let selEmoteFile = document.querySelector( "#selEmoteFile" );
	removeAllChildNodes( selEmoteFile )
	
	let len = npyDatas.length;
	for( let i = 0; i < len; i++ ){
		let val = npyDatas[ i ];
		let text = val.replace( /\.npy$/, "" );
		let op = document.createElement( "option" );
		op.value = val;
		op.text = text;
		selEmoteFile.appendChild( op );
	}
}


///////////////////////////////////////////////////////////////
var audioSrcLabel = document.querySelector( "#audioSrcLabel" );
audioSrcLabel.addEventListener( "dragover", dropDragOverFunc, false );
audioSrcLabel.addEventListener( "dragleave", dropDragleaveFunc, false );
audioSrcLabel.addEventListener( "drop", dropAudioDropFunc, false );
var audioSrc = document.querySelector( "#audioSrc" );
audioSrc.addEventListener( "dragover", dropDragOverFunc, false );
audioSrc.addEventListener( "dragleave", dropDragleaveFunc, false );
audioSrc.addEventListener( "drop", dropAudioDropFunc, false );


function dropDragOverFunc( e ){
	e.stopPropagation();
	e.preventDefault();
	e.target.style.background = '#e1bbf0';
}
function dropDragleaveFunc( e ){
	e.stopPropagation();
	e.preventDefault();
	e.target.style.background = '#ffffff';
}
function dropAudioDropFunc( e ){
	e.stopPropagation();
	e.preventDefault();
	e.target.style.background = '#ffffff';
	
	let files = e.dataTransfer.files;
	let ext = files[ 0 ].name.split('.').pop();
	if( ext != "mp3" && ext != "wav" ){
		return;
	}
	uploadAudiofile( files[ 0 ] );
}

function uploadAudiofile( file ){
	const formData = new FormData();
	formData.append( "file", file );

	const xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function () {
		if( xhttp.readyState === XMLHttpRequest.DONE ){
			const status = xhttp.status;
			if( status === 0 || ( status >= 200 && status < 400 ) ){

				let res = JSON.parse( this.response );

				audioSrc.src = "http://127.0.0.1:15000/tmp/" + res.filepath;
				audioSrc.play();

			} else {
				setInfo( "SERVER_ERROR : Status " + status );
			}
		}
	};
	xhttp.open( "POST", "http://127.0.0.1:15000/uploadFile", true );
	xhttp.send( formData );
}


///////////////////////////////////////////////////////////////

function lockUI( flg ){
	let elements = document.querySelectorAll( 'button' );
	let len = elements.length;
	for( let i = 0; i < len; i++ ){
		elements[ i ].disabled = flg;
	}
	elements = document.querySelectorAll( 'select' );
	len = elements.length;
	for( let i = 0; i < len; i++ ){
		elements[ i ].disabled = flg;
	}
	document.querySelector( '#selSpeakerSerch' ).disabled = flg;
	document.querySelector( '#selTargetSpeakerSerch' ).disabled = flg;


}


///////////////////////////////////////////////////////////////
document.querySelector( "#speedSlider" ).addEventListener( 'input', changeSlider );
document.querySelector( "#noiseSlider" ).addEventListener( 'input', changeSlider );
document.querySelector( "#noisewSlider" ).addEventListener( 'input', changeSlider );
document.querySelector( "#emoteWeightSlider" ).addEventListener( 'input', changeSlider );

function changeSlider( e ){
	document.querySelector( "#" + e.target.dataset[ "targetlabel" ] ).innerHTML = e.target.value;
}


///////////////////////////////////////////////////////////////
var info = document.querySelector( "#info" );
info.addEventListener( 'click', clearInfo );

function clearInfo(){
	info.style.color = '#000000';
	info.style.backgroundColor = '#ffffff';
	info.innerHTML = "Log";
}
function setInfo( text ){
	info.style.color = '#ffffff';
	info.style.backgroundColor = '#ff0000';
	info.innerHTML = text;
}
///////////////////////////////////////////////////////////////
document.querySelector( "#buttonGenerateText" ).addEventListener( 'click', generateAudio );
document.querySelector( "#buttonSymbolText" ).addEventListener( 'click', generateAudio );
document.querySelector( "#buttonGenerateAudio" ).addEventListener( 'click', generateAudio );

function generateAudio( e ){

	clearInfo();

	// create request ////////////////////////////
	let req = {
		generate_type: document.querySelector( "#selConvertType" ).value,
		
		model_dirname: document.querySelector( "#selModel" ).value,
		speaker_id: document.querySelector( "#selSpeaker" ).value,

		text_raw: document.querySelector( "#srcRawText" ).value.replaceAll( /・/g, "…" ),
		text_clean: document.querySelector( "#srcCleanText" ).value,
		sel_clener: document.querySelector( "#selClener" ).value,
		is_cleaned: e.target.dataset.iscleaned,
		is_auto_ja: ( document.querySelector( "#chkAutoJA" ).checked == true ) ? "true" : "false",
		run_marine: ( document.querySelector( "#chkRunMarine" ).checked == true ) ? "true" : "false",

		speed: document.querySelector( "#speedSlider" ).value,
		noise: document.querySelector( "#noiseSlider" ).value,
		noise_w: document.querySelector( "#noisewSlider" ).value,
		
		target_speaker_id: document.querySelector( "#selTargetSpeaker" ).value,
		src_audio_filename: document.querySelector( "#audioSrc" ).src.replace( /http\:\/\/127\.0\.0\.1\:15000\/tmp\//, "" ),
		
		emote_filename: document.querySelector( "#selEmoteFile" ).value,
		emote_weight: document.querySelector( "#emoteWeightSlider" ).value,
	};
console.log( req );
	if( req.model_data_idx == "" ){
		setInfo( "MODEL FOLDER が未選択" );
		return;
	}
	if( req.speaker_id == "" ){
		setInfo( "SPEAKER が未選択" );
		return;
	}
	if( req.generate_type == "VTS" || req.generate_type == "HuBERT" ){
		if( req.src_audio_filename == "" ){
			setInfo( "変換元音声ファイルが存在しません" );
			return;
		}
	}
	if( req.generate_type == "VTS" ){
		if( req.target_speaker_id == "" ){
			setInfo( "TARGET SPEAKER が未選択" );
			return;
		}
	}
	
		
	// send request ////////////////////////////

	lockUI( true );
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function () {
		if( xhttp.readyState === XMLHttpRequest.DONE ){
		
			const status = xhttp.status;
			let res = JSON.parse( this.response );
			
			if( res.error != undefined ){
				setInfo( res.error );
			} else if( status === 0 || ( status >= 200 && status < 400 ) ){
console.log( res );
				addHistory( res );

			} else {
				setInfo( "SERVER_ERROR : Status " + status );
			}
			
			lockUI( false );
		}
	};
	xhttp.open( "POST", "http://127.0.0.1:15000/generateAudio", true );
	xhttp.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" );
	xhttp.send( "&req=" + JSON.stringify( req ) );

}

///////////////////////////////////////////////////////////////////////////////////////////
function addHistory( res ){

	function addLabelRow( val1, val2 ){
		ret = '<div style="font-size: 80%;display: flex; flex-direction: row;">'
			+ '<label style="font-size: 70%;width: 60px; height: 18px; border:1px solid #333333;">' + val1 + '</label>' 
			+ '<label style="width: 100px; height: 18px; border:1px solid #333333;"><b>' + val2.substr( 0, 7 ) + '</b></label>' 
			+ '</div>'
		return ret;
	}

	let req = res.request;
	
	let isTTS = ( req.generate_type == "TTS" ) ? true : false;
	let isVTS = ( req.generate_type == "VTS" ) ? true : false;
	let isHuBERT = ( req.generate_type == "HuBERT" ) ? true : false;
	let isW2V2 = ( req.generate_type == "W2V2" ) ? true : false;
	let is_cleaned = ( req.is_cleaned == "true" ) ? true : false;
	let modelData = getSelectModelData( req.model_dirname );

	let history = document.createElement( "div" );
	history.style = " border:2px solid #333333;";
	history.innerHTML = ''
		+ '<div style="display: none"'
		+ ' data-generate_type="'+ req.generate_type +'"'
		+ ' data-model_dirname="'+ req.model_dirname +'"'
		+ ' data-speaker_id="'+ req.speaker_id +'"'
		
		+ ' data-text_raw="'+ req.text_raw +'"'
		+ ' data-text_clean="'+ res.dist_clean_text +'"'
		+ ' data-sel_clener="'+ req.sel_clener +'"'
		+ ' data-is_cleaned="'+ req.is_cleaned +'"'
		+ ' data-is_auto_ja="'+ req.is_auto_ja +'"'
		+ ' data-run_marine="'+ req.run_marine +'"'
		
		+ ' data-speed="'+ req.speed +'"'
		+ ' data-noise="'+ req.noise +'"'
		+ ' data-noise_w="'+ req.noise_w +'"'
		
		+ ' data-target_speaker_id="'+ req.target_speaker_id +'"'
		+ ' data-src_audio_filename="'+ req.src_audio_filename +'"'

		+ ' data-emote_filename="'+ req.emote_filename +'"'
		+ ' data-emote_weight="'+ req.emote_weight +'"'		
		
		+ ' data-dist_audio_path="'+ res.dist_audio_path +'"'
		+'></div>'
		
		+ '<div style="display: flex; flex-direction: row; margin: 2px 0px 2px 2px;">'
		
		+ '<div style="display: flex; flex-direction: column;">'
		+ addLabelRow( "TYPE", req.generate_type )
		+ addLabelRow( "MODEL", req.model_dirname )
		+ addLabelRow( "SPEAKER", modelData.speakers[ req.speaker_id ] )
		+ (( isVTS ) ? addLabelRow( "TARGET", modelData.speakers[ req.target_speaker_id ] ) : '' )
		+'</div>'
/*
		+ '<div style="display: flex; flex-direction: column;">'
		+ addLabelRow( "CLENER", clener )
		+ addLabelRow( "MARINE", run_marine )
		+ addLabelRow( "SPEED", spped )
		+ addLabelRow( "NOISE", noise )
		+ addLabelRow( "NOISE_W", noiseW )
		+'</div>'
*/
		+ '<div style="display: flex; flex-direction: column; margin: 7px 0px 0px 0px; margin: 0px 0px 0px 10px;">'
		+ (( isTTS || isW2V2 ) ? '<label style="font-size: 80%;width: 800px; height: 25px; border:1px solid #aaaaaa;">' + req.text_raw + '</label>' : '' )
		+ (( isTTS || isW2V2 ) ? '<label style="font-size: 80%;width: 800px; height: 25px; border:1px solid #aaaaaa;">' + res.dist_clean_text + '</label>' : '' )
		+ (( isVTS || isHuBERT ) ? '<audio style="font-size: 80%;width: 800px; height: 25px;" src="http://127.0.0.1:15000/tmp/' + req.src_audio_filename + '" controls></audio>' : '' )
		+ '<audio style="font-size: 80%;width: 800px; height: 25px; filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);" src="http://127.0.0.1:15000/tmp/' + res.dist_audio_path + '" controls></audio>'
		+'</div>'

		+ '<div style="display: flex; flex-direction: column; margin: 7px 0px 0px 0px; margin: 0px 0px 0px 10px;">'
		+ '<button onclick="reeditHistory( event )" style="font-size: 80%;width: 60px; height: 25px;">再編集</button>'
		+ '<div style="font-size: 80%;width: 60px; height: 25px;"></div>'
		+ '<button onclick="deleteHistory( event )" style="font-size: 80%;width: 60px; height: 25px;">削除</button>'
		+'</div>'

		+'</div>'
		
	;
	
	let containerHistory = document.querySelector( "#containerHistory" );
	containerHistory.insertBefore( history, containerHistory.firstChild );

	let audios = history.querySelectorAll( "audio" );
	if( audios.length > 0 ){
		audios[ audios.length - 1 ].loop = true;
		audios[ audios.length - 1 ].play();
	}
}

function setSlider( speed, noise, noiseW ){
	document.querySelector( "#speedSlider" ).value = speed;
	document.querySelector( "#speedLabel" ).innerHTML = speed;
	document.querySelector( "#noiseSlider" ).value = noise;
	document.querySelector( "#noiseLabel" ).innerHTML = noise;
	document.querySelector( "#noisewSlider" ).value = noiseW;
	document.querySelector( "#noisewLabel" ).innerHTML = noiseW;
}

function reeditHistory( e ){
	let parent = e.target.parentNode.parentNode.parentNode;
	let data = parent.querySelector( "[data-generate_type]" );
//console.log( data );
	let generate_type = data.dataset.generate_type;
	let model_dirname = data.dataset.model_dirname;
	let speaker_id = data.dataset.speaker_id;
	
	let text_raw = data.dataset.text_raw;
	let text_clean = data.dataset.text_clean;
	let sel_clener = data.dataset.sel_clener;
	let is_cleaned = data.dataset.is_cleaned;
	let is_auto_ja = data.dataset.is_auto_ja;
	let run_marine = data.dataset.run_marine;
	
	let speed = data.dataset.speed;
	let noise = data.dataset.noise;
	let noise_w = data.dataset.noise_w;
	
	let target_speaker_id = data.dataset.target_speaker_id;
	let src_audio_filename = data.dataset.src_audio_filename;

	let emote_filename = data.dataset.emote_filename;
	let emote_weight = data.dataset.emote_weight;
	
	let dist_audio_path = data.dataset.dist_audio_path;
	
	setSelect( "selModel", model_dirname );
	updateSelectSpeaker();

	updateConvertType();
	setSelect( "selConvertType", generate_type );
	changeUIType();
	
	setSelect( "selSpeaker", speaker_id );
	setSelect( "selTargetSpeaker", target_speaker_id );
	
	setSelect( "selClener", sel_clener );
	document.querySelector( "#chkRunMarine" ).checked = ( run_marine == "false" )? false : true;
	document.querySelector( "#chkAutoJA" ).checked = ( is_auto_ja == "false" )? false : true;
	
	setSlider( speed, noise, noise_w );
	
	document.querySelector( "#srcRawText" ).value = text_raw;
	document.querySelector( "#srcCleanText" ).value = text_clean;
	document.querySelector( "#audioSrc" ).src = "http://127.0.0.1:15000/tmp/" + src_audio_filename;

}

function deleteHistory( e ){
	let parent = e.target.parentNode.parentNode.parentNode.parentNode;
	let target = e.target.parentNode.parentNode.parentNode;
	parent.removeChild( target );
}



///////////////////////////////////////////////////////////////
// initialize
setUIBaseDisplay();
getAllDatas();


/*
function test(){
}
*/
</script>



</body>

</html>


